---
title: "制限ボルツマンマシンの基礎ー概念編ー"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Python","ML"]
published: false
---

## はじめに

機械学習で用いられるボルツマンマシン、特に制限ボルツマンマシン(Restricted Boltzmann Machine, RBM)は非常に面白い概念ですが、その中身の理解は他のニューラルネットワークに比べて難しく、「数式はわかったが、結局何をやっているのか」が分かりにくい印象です。以下では、なるべく平易な言葉で制限ボルツマンマシンが何をしているのか説明してみようと思います。

## 学食問題

### 問題設定

とある大学に通うDaveは、いつもお昼は学食の前のテラスでお弁当を食べます。そして、何の気なしに学食を眺めていると、同じクラスのAliceとBobが学食をよく利用していることに気が付きました。しかし、どうもAliceとBobが同時に現れる確率はかなり低いようです。AliceやBobがお互いに避けているのかと思ってちょっと聞いてみましたが、お互い名前しか知らないようで、特に気にしてないそうです。いったい何が起きているのでしょうか？

Daveは長いこと(239日間！)二人を観察し、AliceとBobが学食に来た日、来ていない日の統計を取りました。

|  A  |  B  | 日数|
| ---- | ---- |---|
|  x  | x  | 35|
|  x  |  o  |56|
|  o  |  x  |113|
|  o  |  o  |35|


例えばAliceもBobも来ていない日は35日、Aliceだけ来てBobが来なかった日は113日ありました。

実は学食を利用していないDaveは知りませんでしたが、この学食は頻繁にカレーフェアを実施しています。Aliceは学食をよく利用していますが、カレーの匂いが苦手なので、カレーフェアの日は学食を利用しません。Bobは普段はあまり学食に来ませんが、カレーが大好きなので、カレーフェアの日は学食を利用する確率が高くなります。カレーフェア(Curry Fair)をCとして、その開催日をo、開催していない日をxとすると、先ほどの内訳はこうなっていました。

|  A  |  B  | C|  日数|
| ---- | ---- | ---- | ---- |
| x | x | x | 28 |
| x | x | o | 7 |
| x | o | x | 7 |
| x | o | o | 49 |
| o | x | x | 112 |
| o | x | o | 1 |
| o | o | x | 28 |
| o | o | o | 7 |


こうして、カレーフェアが無い日はAliceは学食に来てBobは学食に来ない可能性が高く、カレーフェアの日はAliceは学食に来ないでBobが来る可能性が高いため、結果として「AliceとBobが同時に学食に来る可能性が低い」という状態になっていました。

この、AliceとBobの学食への出現確率をモデル化したい、というのが本稿の目的です。本来であれば、Daveは重要な情報であるカレーフェアのことを知りません[^1]。この隠れた情報であるカレーフェアについて、AliceとBobの観測だけから推定しましょう、というのが制限ボルツマンマシンの目的の一つですが、まずは全てを知っている神の立場から、この学食問題をモデル化してみましょう。

[^1]: この学食では「カレーフェア」のポスターや旗などは出しておらず、外からその開催の有無を判断できませｎ。それじゃどうやってAliceやBobはカレーフェアの開催の有無を知るかって？Lineかウェブサイトでチェックしてるんじゃないですか？(投げやり)

### 言葉の定義とネットワークの準備

まず、AliceをA、BobをB、カレーフェアをCと略記します。Daveは蚊帳の外です。AliceやBobが学食に来ているかどうか、カレーフェアをやっているかどうかを変数で表すことにしましょう。例えばある日、Aliceが学食に来ているかどうかを変数$v_a$で表すことにします。これは0か1を取る変数で、$v_a=0$ なら今日はAliceは学食に来ておらず、$v_a=1$ なら学食に来ています。Bobが学食に来ているかどうかも変数$v_b$で表しましょう。同様に、カレーフェアが開催しているかどうかを$h_c$という変数で表すことにします。やはり$h_c = 0$ならカレーフェアを開催しておらず、$h_c = 1$なら開催日です。Daveから見て、AliceやBobが来ているかどうかはわかりますが、カレーフェアをやっているかどうかはわかりません。そこで、AliceやBobは「見える(visible)」変数で、カレーフェアについては「隠れた(hidden)」変数と呼ぶことにします。$v_a, v_b$の$v$は「visible」の頭文字、$h_c$の$h$は「hidden」の頭文字です。

Aliceはカレーフェアが嫌いで、Bobはカレーフェアが好きなので、そこに何か関係がありそうです。AとC、BとCをそれぞれ線で結びましょう。しかし、AliceとBobはお互いに意識していませんので、そこは線で結びません。こうして、以下のような図ができました。

TODO: 図解

ここで、AliceとBobはDaveから見えるので「可視層(visible layer)」、カレーフェアはDaveから見えないので「隠れ層(hidden layer)」と呼びます。

### 重みの定義

AliceとBobは、カレーフェアが影響を及ぼしていますが直接的には無関係なので、まずはAliceとカレーフェアの関係だけを考えましょう。Aliceとカレーフェアを結ぶ線に「重み(weight)」を定義します。この重みを$W_{AC}$で表すことにしましょう。この重みが正なら「Aliceが学食に来て、かつカレーフェアもやっている確率が高い」、つまりAliceがカレーを好きだということを表すことにします。逆にこの重みが負なら、「Aliceが学食にきて、かつカレーフェアもやっている確率が低い」、すなわちAliceがカレーを嫌いだということを表します。今回のケースでは、Aliceはカレーが嫌いですから、$W_{AC}<0$です。

さて、Aliceとカレーフェアを結ぶ線は、「Aliceが学食に来て、かつカレーフェアもやっている可能性」を表現するものでした。したがって、カレーフェアがやっていない、すなわち$h_C=0$の場合はこの重みは無関係です。

このような関係を表すために「Aliceが学食に来たかどうか」と「カレーフェアをやっているかどうか」を表す変数を導入しましょう。まず、Aliceが学食に来たかどうかは、$v_A$という変数で表すことにします。$v_A=1$の時に学食に来ており、$v_A=0$の時には来ていません。同様に、カレーフェアの開催の有無は$h_C$という変数で表現しましょう。我々はカレーフェアについて知っていますが、Daveにはわからないため、Aliceが来たかどうかは見える(visible)ことからvを、カレーフェアについては隠れている(hidden)なのでhを変数に使いました。

カレーフェアが開催しており、かつAliceが学食に来た、という状況の重みを変数を使って表現すると、$W_{AC} v_A h_C$となります。要するに、

* カレーフェアが開催され$h_C=1$、かつ
* Aliceが学食に来た時に$v_A=1$の時だけ
* $W_{AC}$の重みが有効化されるよ

という意味です。

Aliceが学食に来たかどうかと、カレーフェアの開催の有無の表はこうなります。

|  A  |  C  | 日数|
| ---- | ---- |---|
|  x  | x  | 35|
|  x  |  o  |56|
|  o  |  x  |140|
|  o  |  o  |8|

まず、カレーフェアがやっていない日について考えましょう。カレーフェアの無い日は35+140=175日ありました。そのうち、Aliceが学食に来たのは140日ですから、4/5の確率で学食に来ています。

カレーフェアが開催していない日について考えているので$h_C=0$です。したがって、重み$W_{AC} v_A h_C=0$となります。この状態で「Aliceが学食に来やすい」という確率を表すために、新たな重みとしてバイアス$b_A$を導入しましょう。これは、他の変数が全てゼロである場合に、$h_A=1$となりやすいかどうかを表す重みです。$b_A>0$なら、何もない時にAliceが学食に出現する確率が高いことを、$b_A<0$なら、出現する確率が低いことを表します。


カレーフェアのある日は64日中8日、すなわち1/8の確率でしか学食に来ません。

同様に、Bobが学食に来たかどうかと、カレーフェアの開催の有無の表はこうなります。

|  B  |  C  | 日数|
| ---- | ---- |---|
|  x  | x  | 140|
|  x  |  o  |8|
|  o  |  x  |35|
|  o  |  o  |56|

