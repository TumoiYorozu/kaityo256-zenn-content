---
title: "制限ボルツマンマシンの基礎 ～推定編～"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Python","ML","BM","RBM"]
published: false
---

## はじめに

機械学習で用いられるボルツマンマシン、特に制限ボルツマンマシン(Restricted Boltzmann Machine, RBM)の解説その2です。[その1](https://zenn.dev/kaityo256/articles/bolzmann_machine)の続きなので、そちらを見てから読んでください。

## 前回までのあらすじ

ぼっち飯のDaveは、いつも学食前のテラスでお弁当を食べていますが、同じクラスのAliceとBobが学食をよく利用していることに気づきます。しかし、AliceとBobは同時に現れることは少ないようです。AliceとBobは仲が悪いのでしょうか？

そこでDaveは239日にわたって二人を観察し、AliceとBobが学食に来た日、来ていない日の統計を取りました。

|  A  |  B  | 日数|
| ---- | ---- |---|
|  x  | x  | 35|
|  x  |  o  |56|
|  o  |  x  |113|
|  o  |  o  |35|

Daveは、この結果を説明するモデルを作ることにしました。これは、ぼっち飯のDaveによるAliceとBobの調査研究の物語です。

## 確率モデルと最尤推定

Daveがやろうとしているのは、観測事実をもっともよく説明するモデルを作ることです。しかし、「観測事実をもっともよく説明をするモデルを作る」というのは、わりと非自明なことです。

例えばいま、コインを4回投げて、「裏、裏、裏、表」という順番になったとします。このコインの振る舞いを最もよく説明するモデルとはどういうモデルでしょうか？

一番素直なモデルは、「このコインは裏と表が等しい確率で、裏表が毎回独立に出る」と考えることです。つまり、普通の公平なコインということです。その場合、4回投げたら、表が2回出る確率が一番高いですが、表が1度しか出ない確率もさほど低くはありません。

次に、「このコインは、表が出る確率が1/4、裏が出る確率が3/4で、裏表が毎回独立に出る」と考えることもできます。この場合、「4回投げて表が1度しか出ない」確率は、公平なコインよりも高くなります。

もっと極端に、「このコインは機械仕掛けになっており、投げるたびに「裏→裏→裏→表→裏→裏→裏→表・・・」と出る」と考えることもできます。この場合は、「裏、裏、裏、表」と出る確率は100%なので、この「モデル」が一番事象を説明している、といえなくもありません。

完全にランダムと、完全に決定論的の中間で、「このコインは、一度裏が出たら次も裏が出やすい」というモデルを考えることもできます。例えば、次に4回投げて「表、表、表、裏」などが出たら、この説が有力になりますね。これは試行間に相関があると仮定したモデルになります。

以上のように、「コインを4回投げたら裏、裏、裏、表になった」という観測事実を「説明」するモデルは無数に作ることができます。ここでは

* 試行間に相関がない(無相関)
* 表と裏が出る確率が偏っている

という二つの仮定をおいたモデルを考えることにしましょう。表が出る確率を$p$、裏が出る確率を$1-p$とします。試行間に相関がないことを仮定したので、表と裏が出る順番には意味がありません。すると、「4回投げたら裏が3回出た」という観測事実を最もよく説明するように$p$を決めましょう、という問題に落ちます。

確率$p$で表が出る独立な試行は二項分布に従うので、4回のうち1度だけ表が出る確率$P$は

$$
P(p) = 4p(1-p)^3
$$

です。これを最大にするような$p$を知りたいので、$p$で微分しましょう。

$$
\begin{aligned}
P'(p) &= 4(1-p)^3 - 12(1-p)^2 \\
&= 4(1-p)^2(1 - 4p)
\end{aligned}
$$

$P'(p) = 0$より、$p=0, 1/4$と求まります。このうち、$P(p)$が$0\leq p\leq 1$で最大値を取るのは$p=1/4$です。要するに、表が出る確率$p$が$1/2$ではない不公平なコインを$N$回投げて、表が$n$回出た時、表が出る確率を$p=n/N$と推定しましょう、という至極当たり前なことを言っています。

このように、まずモデルを仮定し、その上で観測事実をもっともうまく説明できるようにモデルパラメータを決める手法を最尤推定といいます[^mle]。

ボルツマンマシンに現れる変数が二値であることから、後で現れる最尤推定は基本的に全て不公平なコインと同じものになります。

[^mle]: 最尤推定に限らず、確率まわりは用語の定義が面倒です。本稿ではそのあたりを適当に済ませるので、真面目に学びたい人は真面目な本を読んでください。

## ボルツマンマシンの定義と最尤推定

### 独立モデル

さて、Daveはモデルを作るために統計表を眺めます。

|  A  |  B  | 日数|
| ---- | ---- |---|
|  x  | x  | 35|
|  x  |  o  |56|
|  o  |  x  |113|
|  o  |  o  |35|

AliceとBobが学食に来たかどうかを表す変数を$v_a$、$v_b$とします。$v_a=1$ならAliceが学食に来たことを、$v_a=0$なら来ていないことを表します。Bobを表す変数$v_b$も同様です。

まず、観測日数239日のうち、Aliceが学食に来たのは148日、来なかった日は91日でした。したがって、

$$
P(v_a = 1) = \frac{148}{239}, P(v_a = 0) = \frac{91}{239}
$$

です。同様に、Bobが学食に来たのは91日、来なかったのは148日なので、

$$
P(v_b = 1) = \frac{91}{239}, P(v_a = 0) = \frac{148}{239}
$$

と表せます。さて、AliceとBobが学食に来る確率が全く独立であると仮定してみましょう。すると、AliceとBobが同時に現れる確率は、それぞれ個別の確率の積になるので(確率における独立の定義)

$$
P(v_a=1, v_b=1) = P(v_a = 1) P(v_b = 1) = \frac{148\cdot 91}{239^2}
$$

となります。239日にわたって観測したとすると、二人が同時に現れる日数は$148\cdot 91 / 239 \sim 56.4$日と推定できます。

同様に、残りの表も埋めてみましょう。

|  A  |  B  | 実際の日数| 独立と仮定した時の日数|
| ---- | ---- |---| --- | 
|  x  | x  | 35| 56.4 | 
|  x  |  o  |56| 34.6 | 
|  o  |  x  |113| 91.6|
|  o  |  o  |35| 56.4 |

Daveはこの表を見て、AliceとBobが学食に来る確率は独立ではないと推定することにしました。特に、両方とも学食に来る確率が、独立モデルによる推定よりも低いため、AliceとBobは仲が悪いことが推定されます。

### ボルツマンマシン

次にDaveは、「AliceとBobが仲が悪い」ことを表すモデルを作ることにしました。Daveは、ちょうど大学で学んだボルツマンマシンというモデルを応用することにします。ボルツマンマシンは、1か0を取る変数の実現確率が、外場のあるイジング模型のようなエネルギーで表されるモデルです。AliceとBobの状態を表す変数を$v_a$,$v_b$として、エネルギーを

$$
E(v_a, v_b) = - b_a v_a - b_b v_b - W_{ab} v_a v_b
$$

と定義します。ここで$b_a$、$b_b$は[前の記事](https://zenn.dev/kaityo256/articles/bolzmann_machine)で定義したバイアス、$W_{ab}$は相互作用です。負符号をつけているのは、「パラメータの値が大きいほど、変数が$1$を取りやすい」ことを表現するためです。

ある状態$(v_a, v_b)$の出現確率$P(v_a, v_b)$は

$$
P(v_a, v_b) = \frac{\exp(-E(v_a, v_b))}{Z}
$$

というボルツマン重みで表現されます。ただし$Z$は分配関数で、具体的な表記は

$$
Z = \sum_{v_a}^{0,1}\sum_{v_a}^{0,1} \exp(-E(v_a, v_b))
$$

で与えられます。

まずはAliceのバイアス$b_a$を決めましょう。このバイアスは、他に条件がない場合にどれだけ変数$v_a$が$1$になりやすいかを決めるパラメータで、今回の場合はBobが来ていないという条件でAliceが学食にどれだけ来やすいかを表しています。正なら学食に来やすい、負ならあまり来ないことになります。

|  A  |  B  | 日数|
| ---- | ---- |---|
|  x  | x  | 35|
|  o  |  x  |113|

表を見ると、Bobが来なかったのは148日、そのうちAliceが学食に現れたのは113日です。Bobが来ない時にAliceが来る確率を$p$として、この確率をボルツマンマシンで表現しましょう。

AliceもBobも学食に来ない場合、エネルギーがゼロになるので、

$$
1 - p = P(v_a =0 |  v_b=0) = \frac{1}{\tilde{Z}}
$$

一方、Aliceだけ学食に来る場合の確率は

$$
p = P(v_a =1 | v_b=0) = \frac{\exp(b_a)}{\tilde{Z}}
$$

です。ただし、

$$
\tilde{Z} = 1 + \exp(b_a)
$$

です。

すると、先ほど見た「不公平なコインにおける最尤推定」と全く同じ状況になっています。表が出る(Aliceが来る)確率が$p$、裏が出る(Aliceが来ない)確率が$1-p$のコインを148回投げたら、表が出た(Aliceが来た)回数が113回になったのですから、この観測事実を最も良く説明する$p$は

$$
p = \frac{113}{148}
$$

です。

以上から、

$$
\exp(b_a) = \frac{35}{113}
$$

と推定できます。他のパラメータも同様に決められますが、どうせ全て指数関数の肩に乗った形で出てくるので、以下のように略記することにしましょう。

$$
\begin{aligned}
\exp(b_a) &\equiv w_a\\
\exp(b_b) &\equiv w_b\\
\exp(W_{ab}) &\equiv w_{ab}\\
\end{aligned}
$$

「Aliceが来ていない時のBobの来やすさ」を表すバイアス$b_b$に関しても、同様な表を作って計算できます。

|  A  |  B  | 日数|
| ---- | ---- |---|
|  x  | x  | 35|
|  x  |  o  |56|

ここからただちに

$$
w_b \equiv \exp(b_b) = \frac{56}{35}
$$

と推定できます。